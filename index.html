<!DOCTYPE html>
<html lang="pt-pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

<title>Onde anda o pica?</title>
<link rel="icon" type="image/png" href="/preview.png">
<link rel="apple-touch-icon" href="/preview.png">
<link rel="shortcut icon" href="/preview.png">
<meta name="theme-color" content="#020617">
<meta property="og:title" content="Onde anda o pica?">
<meta property="og:description" content="O passe pesa na carteira — a multa ainda mais.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://ondeandaopica.pt">
<meta property="og:image" content="https://ondeandaopica.pt/preview.png">

<style>
body { margin:0;font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#020617;color:#f1f5f9;padding-bottom:50px;}
.container { max-width:680px;margin:0 auto;padding:20px;text-align:center;position:relative;}
h1 { font-size:2.2rem;margin-bottom:6px;letter-spacing:-0.02em;}
.subtitle { opacity:0.6;font-size:0.95rem;margin-bottom:28px;line-height:1.5;}
.about-btn { position:absolute;top:20px;right:20px;font-size:0.8rem;text-decoration:none;padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.08);color:#cbd5e1;transition:0.2s ease;}
.about-btn:hover { background:rgba(255,255,255,0.14);}
.cta-wrapper { margin-bottom:35px;}
.cta-badge { display:inline-block;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:18px 22px;backdrop-filter:blur(8px);}
.cta-text { font-size:0.9rem;margin-bottom:12px;opacity:0.85;}
.cta-button { display:inline-block;background:#e5392b;color:#ffffff;text-decoration:none;padding:12px 22px;border-radius:10px;font-size:0.85rem;font-weight:600;box-shadow:0 6px 18px rgba(229,57,43,0.25);cursor:pointer;}
.filters { margin-bottom:18px;}
.filters button { background:#0f172a;border:1px solid rgba(255,255,255,0.08);color:#cbd5e1;padding:8px 16px;margin:4px;border-radius:10px;cursor:pointer;font-size:0.85rem;font-weight:600;}
.filters button.active { background:#f1f5f9;color:#020617;}
.status-bar { display:flex;justify-content:space-between;align-items:center;font-size:0.75rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:18px;opacity:0.8;}
.indicator-dot { height:8px;width:8px;border-radius:50%;display:inline-block;margin-right:6px;}
.live-dot { background-color:#22c55e;box-shadow:0 0 8px #22c55e;}
.card { background:#0f172a;border:1px solid rgba(255,255,255,0.05);border-left:6px solid #334155;border-radius:14px;padding:16px;margin-bottom:14px;text-align:left;}
.time { opacity:0.6;font-size:0.85rem;margin-top:6px;}
.empty { text-align:center;padding:40px;opacity:0.4;border:2px dashed #1e293b;border-radius:14px;}

.modal { display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;}
.modal-content { background:#0f172a;padding:24px;border-radius:14px;width:90%;max-width:400px;text-align:left;}
.modal-content h3 { margin-top:0;}
.modal-content select, .modal-content button {
  width:100%;margin-bottom:12px;padding:10px;border-radius:8px;border:1px solid #1e293b;background:#020617;color:#f1f5f9;
}
.close-btn { text-align:right;font-size:0.8rem;cursor:pointer;opacity:0.6;}
</style>
</head>
<body>

<div class="container">

<a href="https://github.com/placeholdertemporary/ondeandaopica"
   target="_blank"
   rel="noopener noreferrer"
   class="about-btn">
  Sobre o projeto
</a>

<h1>Onde anda o pica?</h1>
<div class="subtitle">
   O passe pesa na carteira — a multa ainda mais.
</div>

<div class="cta-wrapper">
  <div class="cta-badge">
    <div class="cta-text">Viste um pica? Avisa a malta.</div>
    <div class="cta-button" onclick="openModal()">REPORTA AQUI</div>
  </div>
</div>

<div class="filters">
  <button id="btn-lisboa" class="active" onclick="setFilter('Lisboa')">Lisboa</button>
  <button id="btn-porto" onclick="setFilter('Porto')">Porto</button>
</div>

<div class="status-bar">
  <div>
    <span class="indicator-dot live-dot"></span>
    <span>Live</span>
  </div>
  <div id="last-update">A sincronizar...</div>
</div>

<div id="updates-list"></div>
</div>

<div id="reportModal" class="modal">
  <div class="modal-content">
    <div class="close-btn" onclick="closeModal()">Fechar ✕</div>
    <h3>Reportar avistamento</h3>

    <select id="citySelect">
      <option value="">Cidade</option>
      <option value="Lisboa">Lisboa</option>
      <option value="Porto">Porto</option>
    </select>

    <select id="lineSelect">
      <option value="">Linha</option>
    </select>

    <select id="directionSelect">
      <option value="">Direção</option>
    </select>

    <select id="picasSelect">
      <option value="">Nº picas</option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3+</option>
    </select>

    <button onclick="submitReport()">Enviar</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>

const supabaseClient = window.supabase.createClient(
  "https://yluetigafaiuwxotezay.supabase.co",
  "sb_publishable_4UYJd6-oteBz1Jt0MTLgOg_LSZHOh2G"
);

let cachedReports = [];
let cachedLines = [];
let currentFilter = "Lisboa";

function openModal(){ 
  document.getElementById("reportModal").style.display="flex";

  const citySelect = document.getElementById("citySelect");
  citySelect.value = currentFilter;

  populateLines(currentFilter);
}
  function closeModal(){ document.getElementById("reportModal").style.display="none"; }

async function loadLines(){
  const { data } = await supabaseClient
    .from("lines")
    .select("*")
    .order("name");

  cachedLines = data || [];
}

function populateLines(city){
  const lineSelect = document.getElementById("lineSelect");
  lineSelect.innerHTML = `<option value="">Linha</option>` +
    cachedLines
      .filter(l => l.city === city)
      .map(l => `<option value="${l.name}">${l.name}</option>`)
      .join("");

  document.getElementById("directionSelect").innerHTML =
    `<option value="">Direção</option>`;
}

async function loadDirections(lineName){
  const line = cachedLines.find(l => l.name === lineName);
  if(!line) return;

  const { data } = await supabaseClient
    .from("directions")
    .select("*")
    .eq("line_id", line.id)
    .order("label");

  const directionSelect = document.getElementById("directionSelect");
  directionSelect.innerHTML = `<option value="">Direção</option>` +
    (data || []).map(d =>
      `<option value="${d.label}">${d.label}</option>`
    ).join("");
}

document.getElementById("citySelect").addEventListener("change", e=>{
  populateLines(e.target.value);
});

document.getElementById("lineSelect").addEventListener("change", e=>{
  loadDirections(e.target.value);
});

async function submitReport(){
  const city = citySelect.value;
  const line = lineSelect.value;
  const direction = directionSelect.value;
  const picas = picasSelect.value;

  if(!city || !line || !direction){
    alert("Preenche todos os campos.");
    return;
  }

  await supabaseClient.from("reports").insert([{
    city,
    line,
    direction,
    picas: picas || null
  }]);

  closeModal();
  fetchReports();
}

function timeAgo(ts){
  const diff = Math.floor((Date.now()-new Date(ts))/60000);
  if(diff < 1) return "agora mesmo";
  if(diff === 1) return "há 1 min";
  if(diff < 60) return `há ${diff} min`;
  return "há mais de 1h";
}

async function fetchReports(){
  const { data } = await supabaseClient
    .from("reports")
    .select("*")
    .gte("created_at", new Date(Date.now()-86400000).toISOString())
    .order("created_at",{ascending:false});

  cachedReports = data || [];
  renderReports();
}
function renderReports(){
  const container = document.getElementById("updates-list");

  const rows = cachedReports.filter(
    r => r.city && r.city.toLowerCase() === currentFilter.toLowerCase()
  );

  if(rows.length===0){
    container.innerHTML =
      `<div class="empty">Nenhum avistamento reportado nas últimas 24 horas. Sorte a tua!</div>`;
    return;
  }

  container.innerHTML = rows.map(r => {

    const lineObj = cachedLines.find(
      l => l.name === r.line && l.city === r.city
    );

    const lineColor = lineObj ? lineObj.color : "#334155";

    return `
      <div class="card" style="border-left:6px solid ${lineColor}">
        <strong>Linha ${r.line} → ${r.direction}</strong>
        ${r.picas ? `<div class="time">${r.picas} picas</div>` : ""}
        <div class="time">${timeAgo(r.created_at)}</div>
      </div>
    `;
  }).join("");

  document.getElementById("last-update").innerText =
    "Atualizado às " +
    new Date().toLocaleTimeString('pt-PT',{
      hour:'2-digit',
      minute:'2-digit'
    });
}

function setFilter(city){
  currentFilter = city;
  document.querySelectorAll(".filters button").forEach(b=>b.classList.remove("active"));
  document.getElementById(`btn-${city.toLowerCase()}`).classList.add("active");
  renderReports();
}
  
async function init(){
  await loadLines();   // ensure lines are loaded first
  await fetchReports();
}

init();
setInterval(fetchReports,15000);

</script>
</body>
</html>
