<!DOCTYPE html>
<html lang="pt-pt">
<head>
<meta charset="UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

<title>Onde anda o pica?</title>
<link rel="icon" type="image/png" href="/preview.png">
<link rel="apple-touch-icon" href="/preview.png">
<link rel="shortcut icon" href="/preview.png">
<meta name="theme-color" content="#020617">
<meta property="og:title" content="Onde anda o pica?">
<meta property="og:description" content="O passe pesa na carteira â€” a multa ainda mais.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://ondeandaopica.pt">
<meta property="og:image" content="https://ondeandaopica.pt/preview.png">

<style>
body { margin:0;font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#020617;color:#f1f5f9;padding-bottom:50px;}
.container { max-width:680px;margin:0 auto;padding:20px;text-align:center;position:relative;}
h1 { font-size:2.2rem;margin-bottom:6px;letter-spacing:-0.02em;}
.subtitle { opacity:0.6;font-size:0.95rem;margin-bottom:28px;line-height:1.5;}
.about-btn { position:absolute;top:20px;right:20px;font-size:0.8rem;text-decoration:none;padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.08);color:#cbd5e1;transition:0.2s ease;}
.about-btn:hover { background:rgba(255,255,255,0.14);}
.cta-wrapper { margin-bottom:35px;}
.cta-badge { display:inline-block;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:18px 22px;backdrop-filter:blur(8px);}
.cta-text { font-size:0.9rem;margin-bottom:12px;opacity:0.85;}
.cta-button { display:inline-block;background:#e5392b;color:#ffffff;text-decoration:none;padding:12px 22px;border-radius:10px;font-size:0.85rem;font-weight:600;box-shadow:0 6px 18px rgba(229,57,43,0.25);}
.filters { margin-bottom:18px;}
.filters button { background:#0f172a;border:1px solid rgba(255,255,255,0.08);color:#cbd5e1;padding:8px 16px;margin:4px;border-radius:10px;cursor:pointer;font-size:0.85rem;font-weight:600;}
.filters button.active { background:#f1f5f9;color:#020617;}
.status-bar { display:flex;justify-content:space-between;align-items:center;font-size:0.75rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:18px;opacity:0.8;}
.indicator-dot { height:8px;width:8px;border-radius:50%;display:inline-block;margin-right:6px;}
.live-dot { background-color:#22c55e;box-shadow:0 0 8px #22c55e;}
.offline-dot { background-color:#f59e0b;box-shadow:0 0 8px #f59e0b;}
.card { background:#0f172a;border:1px solid rgba(255,255,255,0.05);border-left:6px solid #334155;border-radius:14px;padding:16px;margin-bottom:14px;text-align:left;}
.card.azul { border-left-color:#3b6ea8;}
.card.verde { border-left-color:#2f855a;}
.card.amarela { border-left-color:#d4a017;}
.card.vermelha { border-left-color:#c24141;}
.card.violeta { border-left-color:#7c3aed;}
.card.laranja { border-left-color:#d97706;}
.time { opacity:0.6;font-size:0.85rem;margin-top:6px;}
.group-badge { margin-top:10px;font-size:0.8rem;background:rgba(255,120,0,0.15);color:#ff9800;padding:6px 10px;border-radius:8px;display:inline-block;}
.empty { text-align:center;padding:40px;opacity:0.4;border:2px dashed #1e293b;border-radius:14px;}
</style>
</head>
<body>

<div class="container">

<a href="https://github.com/placeholdertemporary/ondeandaopica"
   target="_blank"
   rel="noopener noreferrer"
   class="about-btn">
  Sobre o projeto
</a>

<h1>Onde anda o pica?</h1>
<div class="subtitle">
   O passe pesa na carteira â€” a multa ainda mais.
</div>

<div class="cta-wrapper">
  <div class="cta-badge">
    <div class="cta-text">Viste um pica? Avisa a malta.</div>
    <a class="cta-button"
       href="https://forms.gle/6eaKK6AMvYhuVrsB6"
       target="_blank">REPORTA AQUI</a>
  </div>
</div>

<div class="filters">
  <button id="btn-lisboa" class="active" onclick="setFilter('Lisboa')">Lisboa</button>
  <button id="btn-porto" onclick="setFilter('Porto')">Porto</button>
</div>

<div class="status-bar">
  <div>
    <span id="status-dot" class="indicator-dot live-dot"></span>
    <span id="status-text">Live</span>
  </div>
  <div id="last-update">A sincronizar...</div>
</div>

<div id="updates-list"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>

const supabaseClient = window.supabase.createClient(
  "https://yluetigafaiuwxotezay.supabase.co",
  "sb_publishable_4UYJd6-oteBz1Jt0MTLgOg_LSZHOh2G"
);

let currentFilter = "Lisboa";
let cachedRows = null;

function updateStatus(isLive) {
  const dot = document.getElementById("status-dot");
  const text = document.getElementById("status-text");
  dot.className = "indicator-dot " + (isLive ? "live-dot" : "offline-dot");
  text.innerText = isLive ? "Live" : "Stale";
}

function buildCardHTML(group, colorMap) {
  return `
    <div class="card ${colorMap[group.line] || ""}">
      <strong>Linha ${group.line} â†’ ${group.direction}</strong>
      <div class="time">${group.maxPicas ? group.maxPicas + " picas" : ""}</div>
      <div class="time">${group.tempo || ""}</div>
      ${group.count > 1 ? `<div class="group-badge">ðŸ”¥ ${group.count} avistamentos nesta hora</div>` : ""}
    </div>
  `;
}

function setFilter(city) {
  currentFilter = city;
  document.querySelectorAll(".filters button")
    .forEach(b => b.classList.remove("active"));
  document.getElementById(`btn-${city.toLowerCase()}`)
    .classList.add("active");
  renderData();
}

async function fetchData() {
  try {
    const { data, error } = await supabaseClient
      .from("reports")
      .select("*")
      .gte("created_at", new Date(Date.now() - 24*60*60*1000).toISOString())
      .order("created_at", { ascending: false });

    if (error) throw error;

    cachedRows = data;
    updateStatus(true);
    renderData();

  } catch (err) {
    console.error(err);
    updateStatus(false);
  }
}

function renderData() {
  if (!cachedRows) return;

  const container = document.getElementById("updates-list");
  const groups = {};

  cachedRows.forEach(row => {
    if (row.city !== currentFilter) return;

    const timestamp = new Date(row.created_at);
    const hourKey = `${timestamp.getFullYear()}-${timestamp.getMonth()}-${timestamp.getDate()}-${timestamp.getHours()}`;
    const key = `${row.line}|${row.direction}|${hourKey}`;

    if (!groups[key]) {
      groups[key] = {
        line: row.line,
        direction: row.direction,
        count: 0,
        timestamp
      };
    }

    groups[key].count += 1;

    if (row.picas) {
      groups[key].maxPicas = groups[key].maxPicas
        ? Math.max(groups[key].maxPicas, row.picas)
        : row.picas;
    }

    groups[key].tempo = row.tempo;
  });

  const groupedEntries =
    Object.values(groups).sort((a, b) => b.timestamp - a.timestamp);

  if (groupedEntries.length === 0) {
    container.innerHTML =
      `<div class="empty">Nenhum avistamento reportado nas Ãºltimas 24 horas. Sorte a tua!</div>`;
    return;
  }

  const colorMap = {
    "Azul": "azul",
    "Verde": "verde",
    "Amarela": "amarela",
    "Vermelha": "vermelha",
    "A": "azul",
    "B": "vermelha",
    "C": "verde",
    "D": "amarela",
    "E": "violeta",
    "F": "laranja"
  };

  container.innerHTML =
    groupedEntries.map(g => buildCardHTML(g, colorMap)).join("");

  document.getElementById("last-update").innerText =
    "Atualizado Ã s " +
    new Date().toLocaleTimeString('pt-PT',{
      hour:'2-digit',
      minute:'2-digit'
    });
}

fetchData();
setInterval(fetchData, 15000);

</script>
</body>
</html>
