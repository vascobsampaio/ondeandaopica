<!DOCTYPE html>
<html lang="pt-pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Onde anda o pica?</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#020617">

<style>
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background: #020617;
    color: #f1f5f9;
    padding-bottom: 50px;
  }

  .container {
    max-width: 680px;
    margin: 0 auto;
    padding: 20px;
    text-align: center;
  }

  h1 {
    font-size: 2.2rem;
    margin-bottom: 6px;
    line-height: 1.15;
    letter-spacing: -0.02em;
  }
  
  .subtitle { 
    opacity: 0.6; 
    font-size: 0.95rem; 
    margin-bottom: 28px; 
    line-height: 1.5;
  }

  /* FLOATING CTA BADGE */

  .cta-wrapper {
    margin-bottom: 35px;
  }

  .cta-badge {
    display: inline-block;
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 16px;
    padding: 18px 22px;
    backdrop-filter: blur(8px);
  }

  .cta-text {
    font-size: 0.95rem;
    margin-bottom: 14px;
    opacity: 0.9;
  }

  .cta-button {
    display: inline-block;
    background: #e5392b; /* original red */
    color: #ffffff;
    text-decoration: none;
    padding: 12px 22px;
    border-radius: 10px;
    font-size: 0.85rem;
    font-weight: 600;
    box-shadow: 0 6px 18px rgba(229,57,43,0.25);
    transition: transform 0.1s ease, box-shadow 0.2s ease;
  }

  .cta-button:active {
    transform: scale(0.96);
  }

  /* FILTERS */

  .filters {
    margin-bottom: 18px;
  }

  .filters button {
    background: #0f172a;
    border: 1px solid rgba(255,255,255,0.08);
    color: #cbd5e1;
    padding: 8px 16px;
    margin: 4px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
    opacity: 0.8;
    transition: opacity 0.2s ease, transform 0.1s ease, background 0.2s ease;
  }

  .filters button:hover { opacity: 1; }
  .filters button:active { transform: scale(0.96); }

  .filters button.active {
    background: #f1f5f9;
    color: #020617;
    border: 1px solid #f1f5f9;
    opacity: 1;
    transform: translateY(-1px);
  }

  /* STATUS */

  .status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 18px;
    padding: 0 5px;
    opacity: 0.8;
  }

  .live-dot {
    height: 8px;
    width: 8px;
    background-color: #22c55e;
    border-radius: 50%;
    display: inline-block;
    margin-right: 5px;
    box-shadow: 0 0 8px #22c55e;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.3; }
    100% { opacity: 1; }
  }

  /* CARDS */

  .card {
    background: #0f172a;
    border: 1px solid rgba(255,255,255,0.05);
    border-radius: 14px;
    padding: 16px;
    margin-bottom: 14px;
    font-size: 1rem;
    line-height: 1.4;
    text-align: left;
  }

  .time {
    opacity: 0.6;
    font-size: 0.85rem;
    margin-top: 6px;
  }

  .empty {
    text-align: center;
    padding: 40px;
    opacity: 0.4;
    border: 2px dashed #1e293b;
    border-radius: 14px;
  }
</style>
</head>
<body>

<div class="container">
  <h1>Onde anda o pica?</h1>
  <div class="subtitle">
    Relatos anónimos de revisores avistados<br>pelos metros de Portugal.
  </div>

  <div class="cta-wrapper">
    <div class="cta-badge">
      <div class="cta-text">Viste um pica? Avisa a malta</div>
      <a class="cta-button" href="https://forms.gle/6eaKK6AMvYhuVrsB6" target="_blank">
        REPORTA AQUI
      </a>
    </div>
  </div>

  <div class="filters">
    <button class="btn-lisboa active" onclick="setFilter('lisboa', this)">Lisboa</button>
    <button class="btn-porto" onclick="setFilter('porto', this)">Porto</button>
  </div>

  <div class="status-bar">
    <div><span class="live-dot"></span> Live</div>
    <div id="last-update">À procura do pica...</div>
  </div>

  <div id="updates-list">
    <div class="empty">À procura do pica...</div>
  </div>
</div>

<script>
const TSV_URL = "YOUR_TSV_URL_HERE";

let currentFilter = "lisboa";

function setFilter(filter, btn) {
  currentFilter = filter;
  document.querySelectorAll(".filters button").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  loadData();
}

function parsePortugueseDate(dateStr) {
  if (!dateStr) return new Date(NaN);
  const parts = dateStr.split(/[\s/:]/);
  if (parts.length < 3) return new Date(dateStr);
  let day = parts[0], month = parts[1], year = parts[2];
  if (year.length === 2) year = "20" + year;
  const hour = parts[3] || "00";
  const min = parts[4] || "00";
  return new Date(`${year}-${month}-${day}T${hour}:${min}:00`);
}

async function loadData() {
  try {
    const response = await fetch(TSV_URL + "&t=" + Date.now());
    const text = await response.text();
    const rows = text.trim().split("\n").map(r => r.split("\t"));
    rows.shift();

    const container = document.getElementById("updates-list");
    container.innerHTML = "";

    let entries = [];

    rows.forEach(row => {
      if (row.length < 2) return;
      const timestamp = parsePortugueseDate(row[0].trim());
      const avistamento = row[1].trim();
      if (isNaN(timestamp.getTime())) return;
      entries.push({ timestamp, avistamento });
    });

    entries.sort((a,b)=>b.timestamp-a.timestamp);

    let filtered = entries.filter(entry => {
      const routeLower = entry.avistamento.toLowerCase();
      if (currentFilter === "lisboa") return routeLower.includes("linha");
      if (currentFilter === "porto") return !routeLower.includes("linha");
      return true;
    });

    if (filtered.length === 0) {
      container.innerHTML = `<div class="empty">Nenhum avistamento nas últimas 24 horas. Sorte a tua!</div>`;
      return;
    }

    filtered.forEach(entry => {
      const card = document.createElement("div");
      card.className = "card";

      card.innerHTML = `
        <strong>${entry.avistamento}</strong>
        <div class="time">${entry.timestamp.toLocaleTimeString('pt-PT', {hour:'2-digit', minute:'2-digit'})}</div>
      `;

      container.appendChild(card);
    });

    document.getElementById("last-update").innerText =
      "Atualizado às " + new Date().toLocaleTimeString('pt-PT',{hour:'2-digit',minute:'2-digit'});

  } catch (e) {
    document.getElementById("last-update").innerText = "Erro na ligação";
  }
}

loadData();
setInterval(loadData, 60000);
</script>

</body>
</html>