<!DOCTYPE html>
<html lang="pt-pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

<title>Onde anda o pica?</title>
<link rel="icon" type="image/png" href="/preview.png">
<link rel="apple-touch-icon" href="/preview.png">
<link rel="shortcut icon" href="/preview.png">
<meta name="theme-color" content="#020617">

<style>
body { margin:0;font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#020617;color:#f1f5f9;padding-bottom:50px;}
.container { max-width:680px;margin:0 auto;padding:20px;text-align:center;position:relative;}
h1 { font-size:2.2rem;margin-bottom:6px;letter-spacing:-0.02em;}
.subtitle { opacity:0.6;font-size:0.95rem;margin-bottom:28px;line-height:1.5;}
.about-btn { position:absolute;top:20px;right:20px;font-size:0.8rem;text-decoration:none;padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.08);color:#cbd5e1;transition:0.2s ease;}
.about-btn:hover { background:rgba(255,255,255,0.14);}
.cta-wrapper { margin-bottom:35px;}
.cta-badge { display:inline-block;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:18px 22px;backdrop-filter:blur(8px);}
.cta-text { font-size:0.9rem;margin-bottom:12px;opacity:0.85;}
.cta-button { display:inline-block;background:#e5392b;color:#ffffff;text-decoration:none;padding:12px 22px;border-radius:10px;font-size:0.85rem;font-weight:600;box-shadow:0 6px 18px rgba(229,57,43,0.25);cursor:pointer;}
.filters { margin-bottom:18px;}
.filters button { background:#0f172a;border:1px solid rgba(255,255,255,0.08);color:#cbd5e1;padding:8px 16px;margin:4px;border-radius:10px;cursor:pointer;font-size:0.85rem;font-weight:600;}
.filters button.active { background:#f1f5f9;color:#020617;}
.status-bar { display:flex;justify-content:space-between;align-items:center;font-size:0.75rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:18px;opacity:0.8;}
.indicator-dot { height:8px;width:8px;border-radius:50%;display:inline-block;margin-right:6px;}
.live-dot { background-color:#22c55e;box-shadow:0 0 8px #22c55e;}
.offline-dot { background-color:#f59e0b;box-shadow:0 0 8px #f59e0b;}
.card { background:#0f172a;border:1px solid rgba(255,255,255,0.05);border-left:6px solid #334155;border-radius:14px;padding:16px;margin-bottom:14px;text-align:left;}
.time { opacity:0.6;font-size:0.85rem;margin-top:6px;}
.empty { text-align:center;padding:40px;opacity:0.4;border:2px dashed #1e293b;border-radius:14px;}

/* Modal */
.modal { display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;}
.modal-content { background:#0f172a;padding:24px;border-radius:14px;width:90%;max-width:400px;text-align:left;}
.modal-content h3 { margin-top:0;}
.modal-content select, .modal-content button {
  width:100%;margin-bottom:12px;padding:10px;border-radius:8px;border:1px solid #1e293b;background:#020617;color:#f1f5f9;
}
.close-btn { text-align:right;font-size:0.8rem;cursor:pointer;opacity:0.6;}
</style>
</head>
<body>

<div class="container">

<a href="https://github.com/placeholdertemporary/ondeandaopica"
   target="_blank"
   rel="noopener noreferrer"
   class="about-btn">
  Sobre o projeto
</a>

<h1>Onde anda o pica?</h1>
<div class="subtitle">
   O passe pesa na carteira — a multa ainda mais.
</div>

<div class="cta-wrapper">
  <div class="cta-badge">
    <div class="cta-text">Viste um pica? Avisa a malta.</div>
    <div class="cta-button" onclick="openModal()">REPORTA AQUI</div>
  </div>
</div>

<div class="filters">
  <button id="btn-lisboa" class="active" onclick="setFilter('Lisboa')">Lisboa</button>
  <button id="btn-porto" onclick="setFilter('Porto')">Porto</button>
</div>

<div class="status-bar">
  <div>
    <span id="status-dot" class="indicator-dot live-dot"></span>
    <span id="status-text">Live</span>
  </div>
  <div id="last-update">A sincronizar...</div>
</div>

<div id="updates-list"></div>
</div>

<!-- Modal -->
<div id="reportModal" class="modal">
  <div class="modal-content">
    <div class="close-btn" onclick="closeModal()">Fechar ✕</div>
    <h3>Reportar avistamento</h3>

    <select id="citySelect"></select>
    <select id="lineSelect"></select>
    <select id="directionSelect"></select>
    <select id="picasSelect">
      <option value="">Nº picas</option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3+</option>
    </select>

    <button onclick="submitReport()">Enviar</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>

const supabaseClient = window.supabase.createClient(
  "https://yluetigafaiuwxotezay.supabase.co",
  "sb_publishable_4UYJd6-oteBz1Jt0MTLgOg_LSZHOh2G"
);

let lines = [];
let directions = [];
let cachedRows = [];
let currentFilter = "Lisboa";

function openModal() {
  document.getElementById("reportModal").style.display = "flex";
}
function closeModal() {
  document.getElementById("reportModal").style.display = "none";
}

async function loadFormData() {
  const { data: linesData } = await supabaseClient.from("lines").select("*");
  const { data: dirData } = await supabaseClient.from("directions").select("*");
  lines = linesData || [];
  directions = dirData || [];
  populateCities();
}

function populateCities() {
  const citySelect = document.getElementById("citySelect");
  citySelect.innerHTML = `<option value="">Cidade</option>`;
  ["Lisboa","Porto"].forEach(city=>{
    citySelect.innerHTML += `<option value="${city}">${city}</option>`;
  });
  citySelect.onchange = populateLines;
}

function populateLines() {
  const city = document.getElementById("citySelect").value;
  const lineSelect = document.getElementById("lineSelect");
  lineSelect.innerHTML = `<option value="">Linha</option>`;
  lines.filter(l=>l.city===city)
    .forEach(l=>{
      lineSelect.innerHTML += `<option value="${l.id}">${l.label}</option>`;
    });
  lineSelect.onchange = populateDirections;
}

function populateDirections() {
  const lineId = document.getElementById("lineSelect").value;
  const dirSelect = document.getElementById("directionSelect");
  dirSelect.innerHTML = `<option value="">Direção</option>`;
  directions.filter(d=>d.line_id==lineId)
    .forEach(d=>{
      dirSelect.innerHTML += `<option value="${d.id}">${d.label}</option>`;
    });
}

async function submitReport() {
  const city = document.getElementById("citySelect").value;
  const line_id = document.getElementById("lineSelect").value;
  const direction_id = document.getElementById("directionSelect").value;
  const picas = document.getElementById("picasSelect").value;

  if(!city || !line_id || !direction_id){
    alert("Preenche todos os campos.");
    return;
  }

  await supabaseClient.from("reports").insert([{
    city,
    line_id,
    direction_id,
    picas: picas || null
  }]);

  closeModal();
  fetchData();
}

function timeAgo(timestamp){
  const diff = Math.floor((Date.now()-new Date(timestamp))/60000);
  if(diff < 1) return "agora mesmo";
  if(diff === 1) return "há 1 min";
  if(diff < 60) return `há ${diff} min`;
  return "há mais de 1h";
}

async function fetchData(){
  const { data } = await supabaseClient
    .from("reports")
    .select(`
      created_at,
      picas,
      city,
      line:lines(label),
      direction:directions(label)
    `)
    .gte("created_at", new Date(Date.now()-24*60*60*1000).toISOString())
    .order("created_at",{ascending:false});

  cachedRows = data || [];
  renderData();
}

function renderData(){
  const container = document.getElementById("updates-list");
  const rows = cachedRows.filter(r=>r.city===currentFilter);

  if(rows.length===0){
    container.innerHTML =
      `<div class="empty">Nenhum avistamento reportado nas últimas 24 horas. Sorte a tua!</div>`;
    return;
  }

  container.innerHTML = rows.map(r=>`
    <div class="card">
      <strong>Linha ${r.line?.label || "-"} → ${r.direction?.label || "-"}</strong>
      ${r.picas ? `<div class="time">${r.picas} picas</div>` : ""}
      <div class="time">${timeAgo(r.created_at)}</div>
    </div>
  `).join("");

  document.getElementById("last-update").innerText =
    "Atualizado às " +
    new Date().toLocaleTimeString('pt-PT',{
      hour:'2-digit',
      minute:'2-digit'
    });
}

function setFilter(city){
  currentFilter = city;
  document.querySelectorAll(".filters button").forEach(b=>b.classList.remove("active"));
  document.getElementById(`btn-${city.toLowerCase()}`).classList.add("active");
  renderData();
}

loadFormData();
fetchData();
setInterval(fetchData,15000);

</script>
</body>
</html>
