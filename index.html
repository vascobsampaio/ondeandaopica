<!DOCTYPE html>
<html lang="pt-pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

<title>Onde anda o pica?</title>
<link rel="icon" type="image/png" href="/preview.png">
<link rel="apple-touch-icon" href="/preview.png">
<link rel="shortcut icon" href="/preview.png">
<link rel="manifest" href="/manifest.json">
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js');
  }
</script>

<meta name="theme-color" content="#020617">
<meta property="og:title" content="Onde anda o pica?">
<meta property="og:description" content="O passe pesa na carteira — a multa ainda mais.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://ondeandaopica.pt">
<meta property="og:image" content="https://ondeandaopica.pt/preview.png">

<style>
body { margin:0;font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#020617;color:#f1f5f9;padding-bottom:50px;}
.container { max-width:680px;margin:0 auto;padding:20px;text-align:center;position:relative;}
header { padding-top: 50px; }
h1 { font-size:2.2rem; margin-bottom:6px; letter-spacing:-0.02em; }
.subtitle { opacity:0.6;font-size:0.95rem;margin-bottom:28px;line-height:1.5;}
.about-btn { position:absolute;top:20px;right:20px;font-size:0.8rem;text-decoration:none;padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.08);color:#cbd5e1;transition:0.2s ease;}
.about-btn:hover { background:rgba(255,255,255,0.14);}
.cta-wrapper { margin-bottom:35px;}
.cta-badge { display:inline-block;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:18px 22px;backdrop-filter:blur(8px);}
.cta-text { font-size:0.9rem;margin-bottom:12px;opacity:0.85;}
.cta-button { display:inline-block;background:#e5392b;color:#ffffff;text-decoration:none;padding:12px 22px;border-radius:10px;font-size:0.85rem;font-weight:600;box-shadow:0 6px 18px rgba(229,57,43,0.25);cursor:pointer;}
.filters { margin-bottom:18px;}
.filters button { background:#0f172a;border:1px solid rgba(255,255,255,0.08);color:#cbd5e1;padding:8px 16px;margin:4px;border-radius:10px;cursor:pointer;font-size:0.85rem;font-weight:600;}
.filters button.active { background:#f1f5f9;color:#020617;}
.status-bar { display:flex;justify-content:space-between;align-items:center;font-size:0.75rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:18px;opacity:0.8;}
.indicator-dot { height:8px;width:8px;border-radius:50%;display:inline-block;margin-right:6px;}
.live-dot { background-color:#22c55e;box-shadow:0 0 8px #22c55e;}
.stale-dot { background-color:#f59e0b;box-shadow:0 0 8px #f59e0b;}
.card { background:#0f172a;border:1px solid rgba(255,255,255,0.05);border-left:6px solid #334155;border-radius:14px;padding:16px;margin-bottom:14px;text-align:left;}
.time { opacity:0.6;font-size:0.85rem;margin-top:6px;}
.empty { text-align:center;padding:40px;opacity:0.4;border:2px dashed #1e293b;border-radius:14px;}
.modal { display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:100;}
.modal-content { background:#0f172a;padding:24px;border-radius:14px;width:90%;max-width:400px;text-align:left;}
.modal-content h3 { margin-top:0;}
.modal-content select, .modal-content button {
  width:100%;margin-bottom:12px;padding:10px;border-radius:8px;border:1px solid #1e293b;background:#020617;color:#f1f5f9;
}
.close-btn { text-align:right;font-size:0.8rem;cursor:pointer;opacity:0.6;margin-bottom:10px;}

/* [FIX 1] Success message shown after submit — hidden by default */
.success-msg {
  display:none;
  background:rgba(34,197,94,0.12);
  border:1px solid rgba(34,197,94,0.3);
  color:#86efac;
  border-radius:8px;
  padding:10px 14px;
  font-size:0.85rem;
  margin-bottom:12px;
  text-align:center;
}
</style>
</head>
<body>

<div class="container">
<header>
  <a href="https://github.com/placeholdertemporary/ondeandaopica" target="_blank" rel="noopener noreferrer" class="about-btn">Sobre o projeto</a>
  <h1>Onde anda o pica?</h1>
  <div class="subtitle">O passe pesa na carteira — a multa ainda mais.</div>
</header>

<div class="cta-wrapper">
  <div class="cta-badge">
    <div class="cta-text">Viste um pica? Avisa a malta.</div>
    <div class="cta-button" onclick="openModal()">REPORTA AQUI</div>
  </div>
</div>

<div class="filters">
  <button id="btn-lisboa" class="active" onclick="setFilter('Lisboa')">Lisboa</button>
  <button id="btn-porto" onclick="setFilter('Porto')">Porto</button>
</div>

<div class="status-bar">
  <div>
    <span id="status-dot" class="indicator-dot stale-dot"></span>
    <span id="status-text">A conectar...</span>
  </div>
  <div id="last-update">...</div>
</div>

<div id="updates-list"></div>
</div>

<div id="reportModal" class="modal">
  <div class="modal-content">
    <div class="close-btn" onclick="closeModal()">Fechar ✕</div>
    <h3>Reportar avistamento</h3>

    <!-- [FIX 1] Success banner, shown briefly after a successful submit -->
    <div id="successMsg" class="success-msg">✓ Avistamento reportado, obrigado!</div>

    <!--
      [FIX 3] Added `selected` to the city placeholder.
      Without it, some mobile browsers (especially iOS Safari) ignore
      the .value assignment in openModal() and show a blank select.
    -->
    <select id="citySelect">
      <option value="" disabled selected hidden>Cidade</option>
      <option value="Lisboa">Lisboa</option>
      <option value="Porto">Porto</option>
    </select>

    <select id="lineSelect">
      <option value="" disabled selected hidden>Linha</option>
    </select>

    <select id="directionSelect">
      <option value="" disabled selected hidden>Direção</option>
    </select>

    <select id="picasSelect">
      <option value="" disabled selected hidden>Nº picas</option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3+</option>
    </select>

    <button id="submitBtn" onclick="submitReport()">Enviar</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabaseClient = window.supabase.createClient(
  "https://yluetigafaiuwxotezay.supabase.co",
  "sb_publishable_4UYJd6-oteBz1Jt0MTLgOg_LSZHOh2G"
);

let cachedReports = [];
let cachedLines = [];
let currentFilter = "Lisboa";

function escapeHTML(str) {
  if (!str) return "";
  return str.toString().replace(/[&<>"']/g, m => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
  }[m]));
}

function openModal(){ 
  document.getElementById("reportModal").style.display="flex";

  // Pre-select the city matching the current feed filter
  document.getElementById("citySelect").value = currentFilter;

  // [FIX 4] Hide the success message in case it was visible from a previous open
  document.getElementById("successMsg").style.display = "none";

  populateLines(currentFilter);
}

function closeModal(){
  document.getElementById("reportModal").style.display="none";

  // [FIX 4] Reset all selects so the modal is clean next time it opens
  document.getElementById("citySelect").value = "";
  document.getElementById("lineSelect").innerHTML = `<option value="" disabled selected hidden>Linha</option>`;
  document.getElementById("directionSelect").innerHTML = `<option value="" disabled selected hidden>Direção</option>`;
  document.getElementById("picasSelect").value = "";
}

async function loadLines(){
  const { data, error } = await supabaseClient.from("lines").select("*").order("name");
  if(error){
    console.error("Error loading lines:", error);
    updateStatus(false);
    return;
  }
  cachedLines = data || [];
}

function populateLines(city){
  const lineSelect = document.getElementById("lineSelect");
  lineSelect.value = "";
  document.getElementById("directionSelect").value = "";

  lineSelect.innerHTML =
    `<option value="" disabled selected hidden>Linha</option>` +
    cachedLines
      .filter(l => l.city === city)
      .map(l => `<option value="${escapeHTML(l.name)}">${escapeHTML(l.name)}</option>`)
      .join("");

  document.getElementById("directionSelect").innerHTML =
    `<option value="" disabled selected hidden>Direção</option>`;
}

async function loadDirections(lineName){
  const city = document.getElementById("citySelect").value;
  const line = cachedLines.find(l => l.name === lineName && l.city === city);
  if(!line) return;

  const { data, error } = await supabaseClient
    .from("directions")
    .select("*")
    .eq("line_id", line.id)
    .order("label");

  if(error){
    console.error("Error loading directions:", error);
    return;
  }

  document.getElementById("directionSelect").innerHTML =
    `<option value="" disabled selected hidden>Direção</option>` +
    (data || []).map(d =>
      `<option value="${escapeHTML(d.label)}">${escapeHTML(d.label)}</option>`
    ).join("");
}

document.getElementById("citySelect").addEventListener("change", e => populateLines(e.target.value));
document.getElementById("lineSelect").addEventListener("change", e => loadDirections(e.target.value));

async function submitReport(){
  // Basic rate limiting via localStorage — one report per 5 minutes per browser
  const lastReport = localStorage.getItem('last_report_pica');
  if (lastReport && (Date.now() - parseInt(lastReport)) < 300000) {
    alert("Calma! Só podes reportar uma vez a cada 5 minutos.");
    return;
  }

  const city = document.getElementById("citySelect").value;
  const line = document.getElementById("lineSelect").value;
  const direction = document.getElementById("directionSelect").value;
  const picas = document.getElementById("picasSelect").value;

  if(!city || !line || !direction){
    alert("Preenche todos os campos obrigatórios.");
    return;
  }

  const { error } = await supabaseClient.from("reports").insert([{
    city,
    line,
    direction,
    // [picas is stored as integer, not the string "3+"]
    picas: picas ? parseInt(picas) : null
  }]);

  if(error) {
    alert("Erro ao enviar. Tenta de novo.");
  } else {
    localStorage.setItem('last_report_pica', Date.now());

    // [FIX 1] Show success message inside the modal for 2 seconds, then close
    const msg = document.getElementById("successMsg");
    msg.style.display = "block";
    setTimeout(() => {
      closeModal();
      fetchReports();
    }, 2000);
  }
}

function timeAgo(ts){
  const diffMin = Math.floor((Date.now()-new Date(ts))/60000);

  if(diffMin < 1) return "agora mesmo";
  if(diffMin === 1) return "há 1 min";
  if(diffMin < 60) return `há ${diffMin} min`;

  const diffHours = Math.floor(diffMin/60);
  if(diffHours === 1) return "há 1h";
  if(diffHours < 24) return `há ${diffHours}h`;

  return "há mais de 24h";
}

async function fetchReports(){
  const { data, error } = await supabaseClient
    .from("reports")
    .select("*")
    .eq("city", currentFilter)
    .gte("created_at", new Date(Date.now()-86400000).toISOString())
    .order("created_at",{ascending:false});

  if(error){
    console.error("Error fetching reports:", error);
    updateStatus(false);
    return;
  }

  cachedReports = data || [];

  // [FIX 2] Mark as live after a successful fetch, not just after realtime subscribes.
  // Without this, a failed realtime subscription would leave the dot orange
  // even if polling is working fine.
  updateStatus(true);

  renderReports();
}

function renderReports(){
  const container = document.getElementById("updates-list");
  const filteredRows = cachedReports;

  if(filteredRows.length === 0){
    container.innerHTML = `<div class="empty">Nenhum avistamento nas últimas 24h. Sorte a tua!</div>`;
    return;
  }

  container.innerHTML = filteredRows.map(r => {
    const lineObj = cachedLines.find(l => l.name === r.line && l.city === r.city);
    const lineColor = lineObj ? lineObj.color : "#334155";

    return `
      <div class="card" style="border-left:6px solid ${lineColor}">
        <strong>Linha ${escapeHTML(r.line)} → ${escapeHTML(r.direction)}</strong>
       ${r.picas ? `<div class="time">${r.picas >= 3 ? "3+" : r.picas} pica${r.picas !== 1 ? "s" : ""}</div>` : ""}
        <div class="time">${timeAgo(r.created_at)}</div>
      </div>
    `;
  }).join("");

  document.getElementById("last-update").innerText =
    "Sincronizado: " +
    new Date().toLocaleTimeString('pt-PT',{hour:'2-digit',minute:'2-digit'});
}

function setFilter(city){
  currentFilter = city;
  document.querySelectorAll(".filters button").forEach(b=>b.classList.remove("active"));
  document.getElementById(`btn-${city.toLowerCase()}`).classList.add("active");
  fetchReports();
}

function updateStatus(isLive) {
  const dot = document.getElementById("status-dot");
  const text = document.getElementById("status-text");
  if(isLive) {
    dot.className = "indicator-dot live-dot";
    text.innerText = "Live";
  } else {
    dot.className = "indicator-dot stale-dot";
    text.innerText = "Stale";
  }
}
  
async function init(){
  await loadLines();
  await fetchReports();

  // Realtime subscription — updates the feed instantly when a new report is inserted
  const channel = supabaseClient.channel('reports-realtime');
  
  channel
    .on('postgres_changes',
      { event: 'INSERT', schema: 'public', table: 'reports' },
      payload => {
        // Only add if not already in cache and matches the current city filter
        const exists = cachedReports.some(r => r.id === payload.new.id);
        if(!exists && payload.new.city === currentFilter){
          cachedReports.unshift(payload.new);
          renderReports();
        }
      }
    )
    .subscribe((status) => {
      // Realtime channel status — only affects the dot if fetch hasn't already set it live
      if (status === 'SUBSCRIBED') updateStatus(true);
      else if (status === 'CLOSED' || status === 'CHANNEL_ERROR') updateStatus(false);
    });
// inside init(), after the channel.subscribe() block
// Optimized: Recalculates "time ago" labels without hitting the database
setInterval(() => {
  renderReports(); 
}, 60000);
  
  // Native browser online/offline events as a fallback signal
  window.addEventListener('online', () => updateStatus(true));
  window.addEventListener('offline', () => updateStatus(false));
}

init();
</script>
</body>
</html>
